<!DOCTYPE html>
<html>
<head>
  <script src="jspsych-6.1.0/jspsych.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
  <script src="jspsych-6.1.0/plugins/jspsych-audio-keyboard-response.js"></script>
  <link rel="stylesheet" href="jspsych-6.1.0/css/jspsych.css"></link>
  <style>
  .stimulus { font-size: 32px; }
  </style>
</head>

<script>
var timeline = [];

var instructions = {
  type: 'html-button-response',
  stimulus:'<p>Welcome!</p><p>In this experiment you will listen to music and complete a simple task.</p><p>Focus on the fixation cross + while listening to the music.</p><p>Press the f key when you see a nonword. </p><p>Press the j key when you see a word.</p><p>Respond quickly and accurately to earn a high score.</p>',
  choices: ['Next']
};
timeline.push(instructions);

var stimuli = [
    {word: 'prancing', word_validity: 'valid', word_category: 'narrative'},
    {word: 'feigning', word_validity: 'valid', word_category: 'nonnarrative'},
    {word: 'crouting', word_validity: 'invalid', word_category: 'nonword'},
    {word: 'athiring', word_validity: 'invalid', word_category: 'nonword'}
  ];

var audio = [
  'mp3audio/WA7ldt.mp3',
]

//this plays the full 30 before the trial but we want only 15 with the fixation
var audio_trial1 = {
  type: 'audio-keyboard-response',
  stimulus: 'mp3audio/WA7ldt.mp3',
  prompt: '<span style="font-size:40px;">+</span>',
  choices:['q'], //replace this with JsPsych.NOKEYS once done testing
  trial_ends_after_audio:true
}
timeline.push(audio_trial1);

  var trials = {
    timeline_variables: stimuli,
    randomize_order: true,
    timeline: [
      {
        type: 'html-keyboard-response',
        stimulus: '<p class="stimulus">+</p>',
        choices: jsPsych.NO_KEYS,
        trial_duration: 500,
        post_trial_gap: 0
      },
      {
        type: 'html-keyboard-response',
        stimulus: function(){ return "<p class='stimulus'>"+jsPsych.timelineVariable('word', true)+"</p>"; },
        choices: ['f','j'],
        post_trial_gap: 0,
        data: {
          word_validity: jsPsych.timelineVariable('word_validity'),
          word_category: jsPsych.timelineVariable('word_category')
        },
        on_finish: function(data){
          if(data.word_validity == 'valid'){
            var correct = data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode('f');
          } else {
            var correct = data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode('j');
          }
          data.correct = correct;
        }
      }
    ]
  }
  timeline.push(trials);

  var debrief = {
    type: 'html-keyboard-response',
    choices: ['c'],
    stimulus: function(){
      var narrative_rt = jsPsych.data.get().filter({word_category: 'narrative', correct: true}).select('rt').mean();
      var nonnarrative_rt = jsPsych.data.get().filter({word_category: 'nonnarrative', correct: true}).select('rt').mean();
      var nonword_rt = jsPsych.data.get().filter({word_category: 'nonword', correct: true}).select('rt').mean();

      var message = "<p>All done!</p>"+
        "<p>Your average correct response time for narrative words was "+Math.round(narrative_rt)+"ms.</p>"+
        "<p>Your average correct response time for nonnarrative words was "+Math.round(nonnarrative_rt)+"ms.</p>"+
        "<p>Your average correct response time for nonwords was "+Math.round(nonword_rt)+"ms.</p>"+
        "<p>Press C to see the entire set of data generated by this experiment.</p>";

      return message;

    }
  }
  timeline.push(debrief);


  jsPsych.init({
    timeline: timeline,
    preload_audio: audio,
    use_webaudio: false,
    on_finish: function() {
      jsPsych.data.displayData();
    },
    default_iti: 250
  });
</script>

</html>